<<<template "common/contentHeader.html" .>>>

<div class="box-header">
    <form id="form" class="form-inline" role="form" v-on:submit.prevent='callback(1)'>

        <div class="form-group">
            <label for="project_id">ProjectID:</label>
            <select v-model="currentProjectID" class="form-control" id="project_id" name="project_id" disabled>
                <option value="0">全部</option>
                <option v-for="project in projectList" v-bind:value="project.project_id" v-cloak>{{project.name}}</option>
            </select>
            <!-- /.input group -->
        </div>

        <div class="form-group">
            <label for="dateat">Date:</label>
            <div class="input-group date">
                <div class="input-group-addon">
                    <i class="fa fa-calendar"></i>
                </div>
                <input name="dateat" class="form-control pull-right" id="datepicker" type="text" value="<<<.Dateat>>>" placeholder="请输入日期">
            </div>
            <!-- /.input group -->
        </div>

        <div class="form-group">
            <label for="source_id">渠道:</label>
            <select v-model="currentSourceID" class="form-control" id="source_id" name="source_id">
                <!--option value="0">全部</option-->
                <option v-for="val in sourceList" v-bind:value="val.source_id" v-cloak>{{val.name}}</option>
            </select>
            <!-- /.input group -->
        </div>

        <input type="submit" class="btn btn-info" value="查询"/>
         <!-- 导出excel -->
         <button type="button" class="btn btn-info" @click="export2Excel">导出</button>
    </form>
</div>
<!-- /.box-header -->

<div class="box-body table-responsive no-padding">
    <table id="example2" class="table table-bordered table-hover dataTable" role="grid" aria-describedby="example2_info">

        <thead>
            <tr role="row">
                <th class="sorting_asc" tabindex="0" aria-controls="example2" rowspan="1" colspan="1" aria-sort="ascending" aria-label="activate to sort column descending">日期</th>
                <th class="sorting" tabindex="0" aria-controls="example2" rowspan="1" colspan="1" aria-label="activate to sort column ascending">项目</th>
                <th class="sorting" tabindex="0" aria-controls="example2" rowspan="1" colspan="1" aria-label="activate to sort column ascending">DAU</th>
                <th class="sorting" tabindex="0" aria-controls="example2" rowspan="1" colspan="1" aria-label="activate to sort column ascending">注册人数</th>
                <th class="sorting" tabindex="0" aria-controls="example2" rowspan="1" colspan="1" aria-label="activate to sort column ascending">登录人数</th>
                <th class="sorting" tabindex="0" aria-controls="example2" rowspan="1" colspan="1" aria-label="activate to sort column ascending">回流人数</th>
                <th class="sorting" tabindex="0" aria-controls="example2" rowspan="1" colspan="1" aria-label="activate to sort column ascending">注册次留</th>
                <th class="sorting" tabindex="0" aria-controls="example2" rowspan="1" colspan="1" aria-label="activate to sort column ascending">注册3留</th>
                <th class="sorting" tabindex="0" aria-controls="example2" rowspan="1" colspan="1" aria-label="activate to sort column ascending">注册4留</th>
                <th class="sorting" tabindex="0" aria-controls="example2" rowspan="1" colspan="1" aria-label="activate to sort column ascending">注册5留</th>
                <th class="sorting" tabindex="0" aria-controls="example2" rowspan="1" colspan="1" aria-label="activate to sort column ascending">注册6留</th>
                <th class="sorting" tabindex="0" aria-controls="example2" rowspan="1" colspan="1" aria-label="activate to sort column ascending">注册7留</th>
                <th class="sorting" tabindex="0" aria-controls="example2" rowspan="1" colspan="1" aria-label="activate to sort column ascending">注册10留</th>
                <th class="sorting" tabindex="0" aria-controls="example2" rowspan="1" colspan="1" aria-label="activate to sort column ascending">注册15留</th>
                <th class="sorting" tabindex="0" aria-controls="example2" rowspan="1" colspan="1" aria-label="activate to sort column ascending">登录次留</th>
                <th class="sorting" tabindex="0" aria-controls="example2" rowspan="1" colspan="1" aria-label="activate to sort column ascending">登录3留</th>
                <th class="sorting" tabindex="0" aria-controls="example2" rowspan="1" colspan="1" aria-label="activate to sort column ascending">登录4留</th>
                <th class="sorting" tabindex="0" aria-controls="example2" rowspan="1" colspan="1" aria-label="activate to sort column ascending">登录5留</th>
                <th class="sorting" tabindex="0" aria-controls="example2" rowspan="1" colspan="1" aria-label="activate to sort column ascending">登录6留</th>
                <th class="sorting" tabindex="0" aria-controls="example2" rowspan="1" colspan="1" aria-label="activate to sort column ascending">登录7留</th>
                <th class="sorting" tabindex="0" aria-controls="example2" rowspan="1" colspan="1" aria-label="activate to sort column ascending">登录10留</th>
                <th class="sorting" tabindex="0" aria-controls="example2" rowspan="1" colspan="1" aria-label="activate to sort column ascending">登录15留</th>
            </tr>
        </thead>

        <tbody>
            <template v-for="active in even(activeList)" v-cloak>
                <tr role="row" class="odd">
                    <!--td>{{ active.dateat | formatDate }}</td-->
                    <td>{{ active.today }}</td>
                    <td>{{ active.project_id }}</td>
                    <td>{{ active.dau }}</td>
                    <td>{{ active.regman }}</td>
                    <td>{{ active.logman }}</td>
                    <td>{{ active.backman }}</td>
                    <td>{{ active.left2 }}%</td>
                    <td>{{ active.left3 }}%</td>
                    <td>{{ active.left4 }}%</td>
                    <td>{{ active.left5 }}%</td>
                    <td>{{ active.left6 }}%</td>
                    <td>{{ active.left7 }}%</td>
                    <td>{{ active.left10 }}%</td>
                    <td>{{ active.left15 }}%</td>
                    <td>{{ active.log2 }}%</td>
                    <td>{{ active.log3 }}%</td>
                    <td>{{ active.log4 }}%</td>
                    <td>{{ active.log5 }}%</td>
                    <td>{{ active.log6 }}%</td>
                    <td>{{ active.log7 }}%</td>
                    <td>{{ active.log10 }}%</td>
                    <td>{{ active.log15 }}%</td>
                </tr>
            </template>
        </tbody>

    </table>
</div>
<!-- /.box-body -->

<<<template "common/vuepagination.html" .>>>

<<<template "common/contentFooter.html" .>>>

<script type="text/javascript" src="https://unpkg.com/xlsx/dist/xlsx.full.min.js">
    import XLSX from 'xlsx'
</script>
<script type="text/javascript" src="https://unpkg.com/blob.js@1.0.1/Blob.js"></script>
<script type="text/javascript" src="https://unpkg.com/file-saver@1.3.3/FileSaver.js">
    import FileSaver from 'file-saver'
</script>

<script type="text/javascript">
    //制保留2位小数，如：2，会在2后面补上00.即2.00 
    function toDecimal2(x) { 
        var f = parseFloat(x); 
        if (isNaN(f)) { 
            return false; 
        } 
        var f = Math.round(x*100)/100; 
        var s = f.toString(); 
        var rs = s.indexOf('.'); 
        if (rs < 0) { 
            rs = s.length; 
            s += '.'; 
        } 
        while (s.length <= rs + 2) { 
            s += '0'; 
        } 
        return s; 
    } 
    function formatFloat(src,pos){ 
        return Math.round(src*Math.pow(10, pos))/Math.pow(10, pos); 
    }
    function format2(n,m){ 
        return (n > 0) ? formatFloat(n / m * 100, 2) : n
    }

    var vueReportActive = new Vue({
        el: "#content_<<<.Module>>>_<<<.Action>>>",
        data: {
            pageTitle:'活跃留存',
            menuTitle:'统计管理',
            projectList: <<<.Projects>>>,
            currentProjectID: <<<.ProjectID>>>,
            currentPId: <<<.projectId>>>,
            sourceList: <<<.Sources>>>,
            currentSourceID: <<<.SourceID>>>,
            activeList: <<<.ActiveData>>>,
            form_url: <<<urlfor "ReportController.Active">>>,
            pagination:<<<.Pagination>>>
        },
        components:{
            'vue-nav': Vnav
        },
        methods:{
            export2Excel () {
                /* generate workbook object from table */
                var wb = XLSX.utils.table_to_book(document.querySelector('#example2'))
                /* get binary string as output */
                var wbout = XLSX.write(wb, { bookType: 'xlsx', bookSST: true, type: 'array' })
                try {
                    saveAs(new Blob([wbout], { type: 'application/octet-stream' }), this.pageTitle + '.xlsx')
                } catch (e) { if (typeof console !== 'undefined') console.log(e, wbout) }
                return wbout
            },
            callback(data) {
                this.pagination.currentPage = data;
                var query = $("#form").serialize();
                var query = query + "&page="+data;
                axios.post(this.form_url, query)
                    .then( (response) => {
                        var result = response.data;
                        //console.log("response ", result);
                        if (result.code==200){
                            this.activeList = result.data.ActiveData;
                            this.pagination = result.data.Pagination;
                        }else{
                            $('#modal-error').modal('show')
                            setTimeout(function () {
                                $('#modal-error').modal('hide');
                            }, 3000);
                        }
                    })
                    .catch(function (error) {
                        //console.log("error: ", error);
                        $('#modal-error').modal('show')
                        setTimeout(function () {
                            $('#modal-error').modal('hide');
                        }, 3000);
                    })
            },
            even: function (activeList) {
                if (activeList == null) {
                    return
                }
                var list = this.projectList;
                return activeList.filter(function (active) {
                    for (var i in list) {
                        if (active.project_id == list[i].project_id) {
                            active.project_id = list[i].name
                            //return true
                            break;
                        }
                    }
                    if (active.regman != 0 && active.reghas == null) {
                        active.left2 = format2(active.left2, active.regman);
                        active.left3 = format2(active.left3, active.regman);
                        active.left4 = format2(active.left4, active.regman);
                        active.left5 = format2(active.left5, active.regman);
                        active.left6 = format2(active.left6, active.regman);
                        active.left7 = format2(active.left7, active.regman);
                        active.left10 = format2(active.left10, active.regman);
                        active.left15 = format2(active.left15, active.regman);
                        //TODO 为什么会请求3次?
                        active.reghas = true
                    }
                    if (active.logman != 0 && active.loghas == null) {
                        active.log2 = format2(active.log2, active.logman);
                        active.log3 = format2(active.log3, active.logman);
                        active.log4 = format2(active.log4, active.logman);
                        active.log5 = format2(active.log5, active.logman);
                        active.log6 = format2(active.log6, active.logman);
                        active.log7 = format2(active.log7, active.logman);
                        active.log10 = format2(active.log10, active.logman);
                        active.log15 = format2(active.log15, active.logman);
                        active.loghas = true
                    }
                    return true
                })
            }
        },
        mounted: function() {
            this.$nextTick(function () {
                this.currentProjectID = this.currentPId;
            })
        },
        filters:{
            formatDate: function (time) {
                //var time = "2018-08-23T12:22:19+08:00";
                var time = new Date(time);
                var y = time.getFullYear();//年
                var m = time.getMonth() + 1;//月
                var d = time.getDate();//日
                //var h = time.getHours();//时
                //var mm = time.getMinutes();//分
                //var s = time.getSeconds();//秒
                //return y + "-" + m + "-" + d + " " + h + ":" + mm + ":" + s
                return y + "/" + m + "/" + d
            }
        }
    });
</script>
